#Action 이름을 설정할수 있다. "Java CI with Gradle" 이름으로 설정하면 GitHub Action 대시보드에 설정된 이름으로 Action목록에 표시된다.
name: Java CI with Gradle

#아래는 Event를 정의 할수 있다 다른말로 하면 워크플로가 시작되는 트리거를 말한다
#아래 코드는 main 브렌치에 push될때 워크플로가 동작된다
on:
  push:
    branches: [main]

#아래의 env는 공통으로 쓸 값들을 전역변수처럼 사용할수 있다
#env로 정의한 값들은 \$\{{ env.DOCKER_TOKEN }} 이렇게 사용이 가능하다
env:
  EC2_HOST: ${{ secrets.HOST }}
  EC2_SSH_USER: ubuntu
  PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
  DOCKER_HUB: sppaul/cicd
  CONTAINER_NAME: container
  DOCKER_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}

#github actions에는 여러개 Job으로 구성이 가능하다 아래의 코드는 build-and-push-docker, deploy-to-ec2 2개의 Job로 구성 되어 있다
jobs:
  build-and-push-docker :

    #runs-on이란 해당 actions을 어떤 환경에서 실행시킬지에 대한 값을 입력하는 인자로, github actions를 이용하려면 꼭 필요한 인자이다, 환경이란 OS를 말한다.
    runs-on: ubuntu-latest
    permissions: write-all

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0
        
    - name: Set up application.properties
      run: echo "${{ secrets.PROPERTIES }}" > ./src/main/resources/application.properties

    - name: Build with Gradle authorization #gradlew 권한부여
      run: chmod +x ./gradlew

    - name: Run unit tests
      run: ./gradlew test

    - name: Upload unit test HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: unit-test-report
        path: ${{ github.workspace }}/build/reports/tests/test/

    - name: publish unit test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        files: ${{ github.workspace }}/build/test-results/test/TEST-*.xml

    - name: add comments to a pull request
      uses: mikepenz/action-junit-report@v4
      if: github.event_name == 'pull_request' && always()
      with:
        report_paths: ${{ github.workspace }}/build/test-results/test/TEST-*.xml
    
    - name: Build with Gradle
      run: ./gradlew build
    
    - name: Login to Docker Hub using Access Token
      run: echo "${{ env.DOCKER_TOKEN }}" | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag ${{ env.DOCKER_HUB }}:latest  

    - name: Push the Docker image
      run: docker push ${{ env.DOCKER_HUB }}:latest


  deploy-to-ec2:

    needs: build-and-push-docker
    runs-on: ubuntu-latest

    steps:
    - name: Deploy to EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_SSH_USER }}
        key: ${{ env.PRIVATE_KEY }}
        script: |
         sudo docker rm -f $(docker ps -qa)
         sudo docker pull ${{ env.DOCKER_HUB }}:latest
         docker-compose down
         docker-compose -f /home/ubuntu/docker-compose.yml up --build -d
         docker-compose -f /home/ubuntu/docker-compose.yml up -d
         docker image prune -f
#끝